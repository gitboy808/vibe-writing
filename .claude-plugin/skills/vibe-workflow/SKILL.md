---
name: vibe-workflow
description: Vibe Writing 统筹入口。当用户说"我想写关于"、"探索"、"开始"、"生成卡片"、"迭代"、"润色"、"整理"、"结构"、"成稿"、"输出"、"继续"、"下一轮"时触发。负责路由到 learning/structure/writing/draft agent。
---

# Vibe Workflow - 统筹入口

**职责**: 意图识别 → 路由决策 → 确认引导 → 调用 Subagent

---

## 一、触发条件

**当检测到用户有以下意图时，触发本技能**：

| 意图类型 | 用户表达示例 | 触发关键词 |
|---------|-------------|-----------|
| 开始新项目 | "我想写关于XX"、"探索XX"、"开始" | 我想写、探索、开始 |
| 学习/卡片 | "生成卡片"、"提炼卡片" | 生成卡片 |
| 结构分析 | "结构化"、"输出结构"、"分析下一步" | 结构、分析下一步、输出 |
| 迭代优化 | "迭代"、"润色"、"整理"、"调整" | 迭代、润色、整理、调整 |
| 成稿输出 | "成稿"、"撰写最终稿" | 成稿、撰写、最终输出 |
| 继续任务 | "继续"、"继续下一轮" | 继续 |
| 白板组织 | "组织白板"、"卡片关系" | 组织白板、卡片关系 |

**工作目录条件**：
- 检测到 `项目/*/项目信息.md` 时，按项目阶段路由

---

## 二、意图明确性判断

### 明确意图（直接路由）

| 类型 | 触发条件 | 路由到 |
|-----|---------|--------|
| 快捷命令 | `/结构`、`/迭代`、`/润色`、`/成稿`、`/生成卡片` | 对应 Agent |
| 明确动作词 | "结构化"、"迭代"、"润色"、"输出"、"生成卡片"、"成稿" | 对应 Agent |
| 卡片路径+动作 | "优化《知识卡片X》"、"润色《输出卡片X》" | 结构/写作 Agent |

### 不明确意图（需确认）

| 场景 | 示例 | 处理 |
|-----|------|------|
| 路径+提问 | "[输出卡片路径] 为什么不叫训练？" | 确认是否进入迭代 |
| 无指令闲聊 | "你好"、"继续" | 显示欢迎语或项目状态 |

---

## 三、路由决策

### 3.1 关键词匹配

| 用户输入 | 路由到 | 特殊处理 |
|---------|--------|---------|
| "迭代"、"润色"、"整理"、"调整" | writing-agent | - |
| "结构"、"输出"、"分析下一步" | structure-agent | - |
| "成稿"、"撰写"、"最终输出" | draft-agent | - |
| "生成卡片" | learning-agent | 不等4轮 |
| "继续"、"补充" | 按"当前阶段"路由 | - |
| "我想写关于"、"探索"、"开始" | learning-agent | 新项目 |
| "组织白板"、"卡片关系" | writing-agent | 白板组织 |
| 知识卡片路径 + "优化/输出" | structure-agent | - |
| 输出卡片路径 + 提问/讨论 | writing-agent | 需确认 |

### 3.2 卡片路径+意图分类

**知识卡片路径**（包含 `知识卡片/`）：
- "优化"/"输出" → structure-agent（价值点分析）
- "补充"/"继续" → learning-agent（学习对话）

**输出卡片路径**（包含 `输出卡片/`）：
- "迭代"/"润色"/"修改" → writing-agent（迭代/润色模式）
- 只给路径 + 提问 → 确认引导

### 3.3 默认路由

无匹配时：
1. 读取 `项目/*/项目信息.md`
2. 按"当前阶段"字段路由

---

## 四、确认引导

**格式**：
```
我理解你想[用户意图描述]。
即将进入：[学习/结构/写作/成稿]阶段
确认开始吗？
```

**用户确认后**：
- 学习/结构/成稿 → 立即加载对应 Agent
- 写作（迭代模式）→ 先对话，等用户说"整理"再加载

---

## 五、项目状态检查

### 步骤1：检测项目

```bash
ls 项目/*/项目信息.md
```

### 步骤2：多项目处理

发现多个项目时：
- 列出所有项目及其状态
- 询问用户选择

### 步骤3：单项目处理

读取 `项目信息.md`，检查：
- "当前正在优化"字段 → 有则提示断点续传
- "当前阶段"字段 → 无匹配时按此路由

---

## 六、执行流程

### 路由到 learning-agent 时

1. **读取 subagent 文件**：
   ```
   Read ../agents/learning-agent.md
   ```

2. **调用 subagent**：
   ```
   Task(subagent_type='learning-agent')
   ```

### 路由到 structure-agent 时

1. **读取 subagent 文件**：
   ```
   Read ../agents/structure-agent.md
   ```

2. **调用 subagent**：
   ```
   Task(subagent_type='structure-agent')
   ```

### 路由到 writing-agent 时

1. **读取 subagent 文件**：
   ```
   Read ../agents/writing-agent.md
   ```

2. **调用 subagent**：
   ```
   Task(subagent_type='writing-agent')
   ```

### 路由到 draft-agent 时

1. **读取 subagent 文件**：
   ```
   Read ../agents/draft-agent.md
   ```

2. **调用 subagent**：
   ```
   Task(subagent_type='draft-agent')
   ```

---

## 七、解析 Subagent 返回

识别 `## 【指令】` 开头的指令块，提取类型和参数：

```markdown
## 【指令】创建目录
**命令类型**: bash
**验证命令**: ls -la "项目/xxx"
```bash
mkdir -p "项目/xxx/知识卡片"
```
```

---

## 八、执行指令（强制验证）

**执行优先级**：ask_user > bash > write > edit > read > message

| 类型 | 执行 | 验证 |
|-----|------|------|
| bash | 执行命令 | ls/test 验证 |
| write | 写入文件 | Read 验证 |
| edit | 编辑文件 | Read 验证 |
| read | 读取文件 | 直接返回 |
| ask_user | 显示问题 | 等待回答 |
| message | 显示消息 | - |

---

## 九、场景模式

### 场景A：学习/摄入
**触发词**：新项目、继续对话、生成卡片
**Agent**：learning-agent

### 场景B：结构规划
**触发词**：输出、搭建结构、分析下一步
**Agent**：structure-agent

### 场景C：迭代优化
**触发词**：迭代、润色、修改、调整
**Agent**：writing-agent

### 场景D：成稿撰写
**触发词**：成稿、撰写、最终输出
**Agent**：draft-agent

---

## 十、欢迎语（无项目时）

```
欢迎来到 Vibe Writing！

这里实现真正的**人AI共创**——以你为主体，AI为你的思维伙伴：
- **学习**: 对话探索，激发灵感，总结成知识卡片
- **结构**: 分析价值点，决定讲述逻辑
- **写作**: 迭代优化，你把控内容
- **成稿**: 串联所有内容，形成完整文章

开始吧，你想创作什么？
```

---

